
<!DOCTYPE html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">

  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- <link rel="stylesheet" href="css/normalize.css"> -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="manifest" href="site.webmanifest">
  <link href="https://fonts.googleapis.com/css?family=Cabin+Sketch|Jua|Open+Sans" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <script src="http://js.leapmotion.com/leap-0.6.3.min.js"></script>
  <script src="https://unpkg.com/konva@2.4.2/konva.min.js"></script>
  <script src="js/jscolor.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
</head>

<body>
  <h1>Handimations</h1>

  <button id="color" class="jscolor {valueElement:'chosen-value', onFineChange:'setStrokeColor(this)'}">
    <i class="fas fa-palette fa-3x"></i>
  </button>

  <script>
     //set color from color picker
     function setStrokeColor(picker) {
       curColor = "#" + picker.toString();
     }
  </script>

  <div id="container"></div>

  <script>
    //set up width and height on canvas
    var width = window.innerWidth;
    var height = window.innerHeight - 25;
    var curColor = "#000000";

    // first we need Konva core things: stage and layer
    var stage = new Konva.Stage({
      container: 'container',
      width: width,
      height: height
    });

    //Keep track of layers
    var layer_list = new Array();
    var ly = 0;

    //Add first layer and increment
    layer_list[ly] = new Konva.Layer();
    stage.add(layer_list[ly]);

    // then we are going to draw into special canvas element
    var canvas = document.createElement('canvas');
    canvas.width = stage.width()/2;
    canvas.height = stage.height()/2;

    // created canvas, we can add to layer as "Konva.Image" element
    var image = new Konva.Image({
      image: canvas,
      x: stage.width()/10,
      y: stage.height()/10,
      stroke: 'blue',
      shadowBlur: 5
    });
    layer_list[ly].add(image);
    stage.draw();

    //get access to context element
    var context = canvas.getContext('2d');
    context.strokeStyle = curColor;
    context.lineJoin = "round";
    context.lineWidth = 5;

    //Determine whether it is a swipe motion or extended fingers
    var swipeMotion = false;
    var extendedFingers = 0;

    //Set up history of drawings
    var clickX = new Array();
    var clickY = new Array();
    var clickColor = new Array();
    var clickMode = "draw";
    var prevColor = curColor;

    //Set start x and y coordinate history
    //Plot on image layer
    clickX.push(image.x());
    clickY.push(image.y());
    clickColor.push(curColor);
    var inx = 0;

    // Create LeapMotion controller, and related objects
    var controller = Leap.loop({enableGestures: true}, function(frame){
      /* The amount of fingers is not 5 (swipe motion) but there are fingers held out
        Check how many fingers are extended */
      if(frame.hands.length == 1){
        //One hand is held out over LeapMotion
        var hand = frame.hands[0];
        for(var f = 0; f < hand.fingers.length; f++){
          var finger = hand.fingers[f];
          if(finger.extended) extendedFingers++;
        }
      }

      //Debug: Prints how many fingers are extended
      console.log(extendedFingers);

      //Depending on how many fingers are extended, execute drawing or new layer creation
      if (extendedFingers > 0) {
        //Debug: Prints if the if-statement is entered
        console.log("!!!");

        if (extendedFingers == 5) {
            //If 5 - swipe for new layer
            //All fingers are held out - so check if it is a swipe gesture
            if(frame.valid && frame.gestures.length > 0){
              frame.gestures.forEach(function(gesture){
                  switch (gesture.type){
                    case "swipe":
                        /* Check if all five fingers are used for swipe and direction is moving right
                        If 5, create a new layer */
                        if(gesture.direction[0] > 0 && swipeMotion == false){
                          image = new Konva.Image({
                            image: canvas,
                            x: stage.width()/10,
                            y: stage.height()/10
                          });

                          //Create a new layer and append it to layer list
                          ly++;
                          layer_list[ly] = new Konva.Layer();
                          layer_list[ly].add(image);
                          stage.add(layer_list[ly]);
                          stage.draw();

                          //Debug
                          console.log("New layer");

                          swipeMotion = true;
                        }

                        var isPaint = false;
                        var lastPointerPosition;
                        var mode = 'brush';

                        break;
                  }
              });
            }
        } else if (extendedFingers == 1){
            //If 1-4 fingers - drawing
            //Get index finger from the hand - returns a pointable object
            var indexFinger = hand.indexFinger;
            var pinkyFinger = hand.pinky;
            var interactionBox = frame.interactionBox;

            if (indexFinger.extended){
              //Only the index finger is extended
              //Debug:
              console.log("Drawing");

              var normalizedPosition = interactionBox.normalizePoint(indexFinger.stabilizedTipPosition, true);
              context.lineWidth = 5;
              clickMode = "draw";

            } else if (pinkyFinger.extended){
              //Only the pinky is extended
              //Debug:
              console.log("Erasing");

              //Set the cursor color and disable the color picker
              var normalizedPosition = interactionBox.normalizePoint(pinkyFinger.stabilizedTipPosition, true);
              clickMode = "erase";
              context.lineWidth = 10;
              prevColor = curColor;
              curColor = "ffffff";
              document.getElementById("color").disabled = true;

            }

            if(pinkyFinger.extended || indexFinger.extended){
              // Convert the normalized coordinates to span the canvas
              var canvasX = canvas.width * normalizedPosition[0];
              var canvasY = canvas.height * (1 - normalizedPosition[1]);

              //Set Konva image start point since the layer is dependent on a cursor
              // clickLines[curLine][0].push(image.x());
              // clickLines[curLine][1].push(image.y());

              //Add the coordinates to the history
              clickX.push(Math.floor(canvasX));
              clickY.push(Math.floor(canvasY));
              clickColor.push(curColor);
              inx++;

              context.beginPath();
              context.moveTo(clickX[inx-1], clickY[inx-1]);
              context.lineTo(clickX[inx], clickY[inx]);
              context.closePath();
              context.strokeStyle = clickColor[inx];
              context.stroke();

              layer_list[ly].batchDraw();

              //Set the current color to the previous color used now that erasing is done
              if(pinkyFinger.extended){
                curColor = prevColor;
              }

            }
        } else {
            //No extended fingers detected, so mouse drawing enabled

            /* now we need to bind some events
               we need to start drawing on mousedown
               and stop drawing on mouseup */
            var isPaint = false;
            var lastPointerPosition;
            var mode = 'brush';

            image.on('mousedown touchstart', function () {
              isPaint = true;
              lastPointerPosition = stage.getPointerPosition();

            });

            // will it be better to listen move/end events on the window?
            stage.addEventListener('mouseup touchend', function () {
              isPaint = false;
            });

            // and core function - drawing
            stage.addEventListener('mousemove touchmove', function () {
              if (!isPaint) {
                return;
              }

              if (mode === 'brush') {
                context.globalCompositeOperation = 'source-over';
              }
              if (mode === 'eraser') {
                context.globalCompositeOperation = 'destination-out';
              }
              context.beginPath();

              var localPos = {
                x: lastPointerPosition.x - image.x(),
                y: lastPointerPosition.y - image.y()
              };
              context.moveTo(localPos.x, localPos.y);
              var pos = stage.getPointerPosition();
              localPos = {
                x: pos.x - image.x(),
                y: pos.y - image.y()
              };
              context.lineTo(localPos.x, localPos.y);
              context.closePath();
              context.strokeStyle = curColor;
              context.stroke();

              lastPointerPosition = pos;
              layer_list[ly].batchDraw();
            });
        }
      }
      //pointableOutput.innerHTML = pointableString;

      //reset for next frame
      extendedFingers = 0;
      swipeMotion = false;
      document.getElementById("color").disabled = false;
   });
   controller.connect();
  </script>

  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>

  <div id="main">
     <h3>History:</h3>
     <div id="pointableData" style="overflow-y: scroll; height:400px;"></div>
     <div style="clear:both;"></div>
  </div>

</body>
</html>
