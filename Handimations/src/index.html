<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="manifest" href="site.webmanifest">

  <!-- <link rel="stylesheet" href="css/normalize.css"> -->
  <link rel="stylesheet" href="css/main.css">
  <link href="https://fonts.googleapis.com/css?family=Cabin+Sketch|Jua|Open+Sans" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <script src="http://js.leapmotion.com/leap-0.6.3.min.js"></script>
  <script src="https://unpkg.com/konva@2.4.2/konva.min.js"></script>

  <script src="js/jscolor.js"></script>

  <img id="pencil-cursor" src="img/pencil-cursor.png" style="display: none">
</head>

<body>

  <h1>Handimations</h1>

  <button id="color" class="jscolor {valueElement:'chosen-value', onFineChange:'setStrokeColor(this)'}">
    <i class="fas fa-palette fa-3x"></i>
  </button>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>


  <script>
  function vectorToString(vector, digits) {
    if (typeof digits === "undefined") {
      digits = 1;
    }
    return "(" + vector[0].toFixed(digits) + ", "
               + vector[1].toFixed(digits) + ", "
               + vector[2].toFixed(digits) + ")";
  }
  function togglePause() {
    paused = !paused;
    if (paused) {
      document.getElementById("pause").innerText = "Resume";
    } else {
      document.getElementById("pause").innerText = "Pause";
    }
  }
  function pauseForGestures() {
    if (document.getElementById("pauseOnGesture").checked) {
      pauseOnGesture = true;
    } else {
      pauseOnGesture = false;
    }
  }
  </script>

  <canvas id="displayArea" width="1200" height="600" style="background:#ffffff; border:3px solid #0000ff;"></canvas>
  <script>
    var controller = new Leap.Controller();

    var stage = new Konva.Stage({
      container: 'container',
      width: "1200 px",
      height: "600 px"
    });

    //Create layer, make a function to create multiple layers
    var layer = new Konva.layer();
    stage.add(layer);

    var canvasElement = document.getElementById("displayArea");
    var displayArea = canvasElement.getContext("2d");

    var curColor = "#b642f4";
    var prevColor = curColor;
    var clickX = new Array();
    var clickY = new Array();
    var clickDrag = new Array();
    var clickColor = new Array();
    var clickMode = "draw";

    var drawMode = false;
    var eraseMode = false;

    displayArea.strokeStyle = curColor;
    displayArea.lineJoin = "round";
    displayArea.lineWidth = 5;

    var pencilImg = document.getElementById("pencil-cursor");

    //set color to value selected from color picker
    function setStrokeColor(picker) {
      curColor = "#" + picker.toString();
    }

    function isControlFinger(controllerFingerIdx, frame) {
      var isOnlyOneExtended = true;
      for (j = 0; j < frame.pointables.length; j++) {
        if (j != controllerFingerIdx) {
          isOnlyOneExtended = !frame.pointables[j].extended;
        }
      }
      return isOnlyOneExtended;
    }

    function addLine() {
      var line = new Array();
      line.push(clickX);
      line.push(clickY);
      line.push(clickColor);
      line.push(clickMode);
      clickLines.push(line);
      curLine++;
    }

    controller.on("frame", function(frame) {
    // Display Pointable (finger and tool) object data
    var pointableOutput = document.getElementById("pointableData");
    var pointableString = "";
    if (frame.pointables.length > 0) {
      var fingerTypeMap = ["Thumb", "Index finger", "Middle finger", "Ring finger", "Pinky finger"];
      var boneTypeMap = ["Metacarpal", "Proximal phalanx", "Intermediate phalanx", "Distal phalanx"];
      for (var i = 0; i < frame.pointables.length; i++) {
        var pointable = frame.pointables[i];
        pointableString += "<div style='width:250px; float:left; padding:5px'>";
        if (pointable.tool) {
          pointableString += "Pointable ID: " + pointable.id + "<br />";
          pointableString += "Classified as a tool <br />";
          pointableString += "Length: " + pointable.length.toFixed(1) + " mm<br />";
          pointableString += "Width: "  + pointable.width.toFixed(1) + " mm<br />";
          pointableString += "Direction: " + vectorToString(pointable.direction, 2) + "<br />";
          pointableString += "Tip position: " + vectorToString(pointable.tipPosition) + " mm<br />"
          pointableString += "</div>";
        }
        else {
          //pointableString += "Pointable ID: " + pointable.id + "<br />";
          pointableString += "Type: " + fingerTypeMap[pointable.type] + "<br />";
          //pointableString += "Belongs to hand with ID: " + pointable.handId + "<br />";
          pointableString += "Classified as a finger<br />";
          //pointableString += "Length: " + pointable.length.toFixed(1) + " mm<br />";
          //pointableString += "Width: "  + pointable.width.toFixed(1) + " mm<br />";
          //pointableString += "Direction: " + vectorToString(pointable.direction, 2) + "<br />";
          pointableString += "Extended?: "  + pointable.extended + "<br />";
          pointableString += "Tip position: " + vectorToString(pointable.tipPosition) + " mm<br />";
          pointableString += "</div>";
        }
      }
    }
    else {
      pointableString += "<div>No pointables</div>";
    }

    pointableOutput.innerHTML = pointableString;
    if (frame.pointables.length == 0) {
      drawMode = false;
      eraseMode = false;
    } else {
      canvasElement.width = canvasElement.width; //clear
      var fingerTypeMap = ["Thumb", "Index finger", "Middle finger", "Ring finger", "Pinky finger"];

      var controllerFinger = frame.pointables[0];
      if (!drawMode && !eraseMode){ // Check if we need to toggle mode on
        // Check if it's an index finger and it's the only one extended
        // Alternatively, check if it's a pinky finger and it's the only oneextended
        for (i = 0; i < frame.pointables.length; i++) {
          if ( (fingerTypeMap[frame.pointables[i].type] == "Index finger") && (frame.pointables[i].extended) ) {
            drawMode = isControlFinger(i, frame);
            if (drawMode) {
              controllerFinger = frame.pointables[i];
              clickX = new Array();
              clickY = new Array();
              clickColor = new Array();
              clickMode = "draw";
              document.getElementById("color").disabled = false;
            }
          } else if( (fingerTypeMap[frame.pointables[i].type] == "Pinky finger") && (frame.pointables[i].extended) ) {
              eraseMode = isControlFinger(i, frame);
              if (eraseMode) {
                controllerFinger = frame.pointables[i];
                clickX = new Array();
                clickY = new Array();
                clickColor = new Array();
                clickMode = "erase";
                prevColor = curColor;
                curColor = "#ffffff";
                document.getElementById("color").disabled = true;
              }
          }
       }
    } else if (drawMode){ // If we're in draw mode, check if the index finger is no longer extended
       for (i = 0; i < frame.pointables.length; i++) {
         if ( (fingerTypeMap[frame.pointables[i].type] == "Index finger") && ( (!frame.pointables[i].extended) || !isControlFinger(i, frame) ) ) {
           // Toggle out of drawMode
           drawMode = false;
           // Push to clickLines
           addLine();
           break;
         }
       }
    } else if (eraseMode){ // If we're in erase mode, check if the pinky finger is no longer extended
       for (i = 0; i < frame.pointables.length; i++) {
         if ( (fingerTypeMap[frame.pointables[i].type] == "Pinky finger") && ( (!frame.pointables[i].extended) || !isControlFinger(i, frame) ) ) {
           // Toggle out of eraseMode
           eraseMode = false;
           // Push to clickLines
           addLine();
           curColor = prevColor;
           break;
         }
      }
    }

    var interactionBox = frame.interactionBox;
    var normalizedPosition = interactionBox.normalizePoint(controllerFinger.stabilizedTipPosition, true);

    // Convert the normalized coordinates to span the canvas
    var canvasX = canvasElement.width * normalizedPosition[0];
    var canvasY = canvasElement.height * (1 - normalizedPosition[1]);
    //we can ignore z for a 2D context

    if (drawMode || eraseMode){
      clickLines[curLine][0].push(canvasX);
      clickLines[curLine][1].push(canvasY);
      clickLines[curLine][2].push(curColor);
      clickLines[curLine][3] = clickMode;
    }

    for (var i = 0; i < clickLines.length; i++) { //For every line segment
      var line = clickLines[i];
      var xPoints = line[0];
      var yPoints = line[1];
      var colorPoints = line[2];

      if (line[3] == "draw") {
        displayArea.lineWidth = 5;
      } else if (line[3] == "erase") {
        displayArea.lineWidth = 10;
      }

      for (var j = 1; j < xPoints.length; j++) {//For every point on these lines
        displayArea.beginPath();
        displayArea.moveTo(xPoints[j-1], yPoints[j-1]);

        displayArea.lineTo(xPoints[j], yPoints[j]);
        displayArea.closePath();
        displayArea.strokeStyle = colorPoints[j];
        displayArea.stroke();

        layer.batchDraw();
      }
    }

    displayArea.drawImage(pencilImg,canvasX,canvasY-25); //draw pencil cursor
  }

  });

  controller.connect();
</script>

  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>

  <div id="main">
    <!-- <h1>Leap Motion Data</h1> -->
    <button id="pause" onclick="togglePause()">Pause</button>
    <input type="checkbox" id="pauseOnGesture" onclick="pauseForGestures()">Pause on gesture</input>
    <div style="clear:both;"></div>
    <h3>Finger and tool data:</h3>
    <div id="pointableData"></div>
    <div style="clear:both;"></div>
  </div>

</body>

</html>
