<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="manifest" href="site.webmanifest">

  <!-- <link rel="stylesheet" href="css/normalize.css"> -->
  <link rel="stylesheet" href="css/main.css">
  <link href="https://fonts.googleapis.com/css?family=Cabin+Sketch|Jua|Open+Sans" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <script src="http://js.leapmotion.com/leap-0.6.3.min.js"></script>

  <script src="js/jscolor.js"></script>

  <img id="pencil-cursor" src="img/pencil-cursor.png" style="display: none">
</head>

<body>
  <div class="topBar">
    <h1>Handimations</h1>
  </div>

  <div class="toolbar">
    <button id="color" class="jscolor {valueElement:'chosen-value', onFineChange:'setStrokeColor(this)'}">
      <i class="fas fa-palette fa-2x"></i>
    </button>

    <div class="mode-toolbar">
      <input type="radio" id="draw" name="mode" value="draw" checked>
      <label for="draw"><i class="fas fa-pencil-alt fa-2x"></i></label>

      <input type="radio" id="erase" name="mode" value="erase">
      <label for="erase"><i class="fas fa-eraser fa-2x"></i></label>
    </div>

    <button id="new-layer">
      <svg width="100%" height="100%" viewBox="0 0 181 174" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:1.5;">
        <path d="M55.544,107.47l-50.544,22.427l85.758,38.139l84.989,-39.349l-49.025,-22.927" style="fill:none;stroke:#000;stroke-width:10px;" />
        <path d="M143.01,5l0,56.774" style="fill:none;stroke:#000;stroke-width:10px;" />
        <path d="M171.397,31.783l-56.774,0" style="fill:none;stroke:#000;stroke-width:10px;" />
        <path d="M83.939,48.966l-76.181,33.81l82.668,38.336l83.332,-35.386" style="fill:none;stroke:#000;stroke-width:10px;" />
      </svg>
    </button>

    <button id="export"><i class="fas fa-file-export fa-2x"></i></button>
    <button id="trash" onclick="trashit()"><i class="fas fa-trash fa-2x"></i></button>



  </div>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>


  <script>
    function vectorToString(vector, digits) {
      if (typeof digits === "undefined") {
        digits = 1;
      }
      return "(" + vector[0].toFixed(digits) + ", "
                 + vector[1].toFixed(digits) + ", "
                 + vector[2].toFixed(digits) + ")";
    }

    function togglePause() {
      paused = !paused;
      if (paused) {
        document.getElementById("pause").innerText = "Resume";
      } else {
        document.getElementById("pause").innerText = "Pause";
      }
    }

    function pauseForGestures() {
      if (document.getElementById("pauseOnGesture").checked) {
        pauseOnGesture = true;
      } else {
        pauseOnGesture = false;
      }
    }
  </script>

  <canvas id="displayArea" width="1200" height="600" style="background:#ffffff; border:3px solid #123456;"></canvas>
  <script>
    //Globals
  let canvasElement = document.getElementById("displayArea");
  let displayArea = canvasElement.getContext("2d");

  let extendedFingers = 0;

  let drawMode = false;
  let eraseMode = false;
  // drawModeActive = document.getElementById("draw");
  // eraseModeActive = document.getElementById("draw");

  let curColor = "#123456";
  let prevColor = curColor;
  let clickX;
  let clickY;
  let clickDrag;
  let clickColor;
  let clickMode;

  let clickLines;
  let curLine;
  reset();

  let pencilImg = document.getElementById("pencil-cursor");

  //Set/reset image
  function reset() {
    clickX = new Array();
    clickY = new Array();
    clickDrag = new Array();
    clickColor = new Array();
    clickMode = "draw";

    clickLines = new Array();
    curLine = -1;
    addLine();
  }

  //Add new point data to current line
  function addPoint(canvasX, canvasY) {
    clickLines[curLine][0].push(canvasX);
    clickLines[curLine][1].push(canvasY);
    clickLines[curLine][2].push(curColor);
    clickLines[curLine][3] = clickMode;
  }

  //Display paths drawn
  function redraw(canvasX, canvasY) {
    displayArea.clearRect(0, 0, displayArea.canvas.width, displayArea.canvas.height);
    displayArea.lineJoiun = "round";

    for (let i = 0; i < clickLines.length; i++) { //For every line segment
      let line = clickLines[i];
      let xPoints = line[0];
      let yPoints = line[1];
      let colorPoints = line[2];
      if (line[3] == "draw") {
        displayArea.lineWidth = 5;
      }
      else if (line[3] == "erase") {
        displayArea.lineWidth = 10;
      }
      for (let j = 1; j < xPoints.length; j++) {//For every point on these lines
        displayArea.beginPath();
        displayArea.moveTo(xPoints[j-1], yPoints[j-1]);

        displayArea.lineTo(xPoints[j], yPoints[j]);
        displayArea.closePath();
        displayArea.strokeStyle = colorPoints[j];
        displayArea.stroke();
      }
    }
    displayArea.drawImage(pencilImg,canvasX,canvasY-25); //Draw pencil cursor
  }

  //Set color to value selected from color picker
  function setStrokeColor(picker) {
    curColor = "#" + picker.toString();
  }

  //Check whether a single finger is extended
  function isControlFinger(controllerFingerIdx, frame) {
    let isOnlyOneExtended = true;
    for (let j = 0; j < frame.pointables.length; j++) {
      if (j != controllerFingerIdx) {
        isOnlyOneExtended = !frame.pointables[j].extended;
      }
    }
    return isOnlyOneExtended;
  }

  //Add completed line to array of lines to be displayed
  function addLine() {
    let line = new Array();
    line.push(clickX);
    line.push(clickY);
    line.push(clickColor);
    line.push(clickMode);
    clickLines.push(line);
    curLine++;
  }

  //Mouse Mode
  //Start new line
  $("#displayArea").mousedown(function(e) {
    mouseX = e.pageX - this.offsetLeft;
    mouseY = e.pageY - this.offsetTop;
    drawMode = clickMode == "draw";
    eraseMode = !drawMode;
    clickX = new Array();
    clickY = new Array();
    clickColor = new Array();
    document.getElementById("color").disabled = eraseMode;
    console.log(clickMode);
    addPoint(mouseX, mouseY);
    redraw(mouseX, mouseY);
  });

  //Toggle modes
  $("#displayArea").dblclick(function(e) {
    if (clickMode == "draw") {
      clickMode = "erase";
      prevColor = curColor;
      curColor = "#ffffff";
      document.getElementById("draw").checked = false;
      document.getElementById("erase").checked = true;
    }
    else {
      clickMode = "draw";
      curColor = prevColor;
      document.getElementById("draw").checked = true;
      document.getElementById("erase").checked = false;
    }
    console.log(clickMode);
  });

  //Plot line
  $("#displayArea").mousemove(function(e) {
    mouseX = e.pageX - this.offsetLeft;
    mouseY = e.pageY - this.offsetTop;
    if (drawMode || eraseMode) {
      addPoint(mouseX, mouseY);
      redraw(mouseX, mouseY);
    }
  });

  //End line
  $("#displayArea").mouseup(function(e) {
    drawMode = false;
    eraseMode = false;
    mouseX = e.pageX - this.offsetLeft;
    mouseY = e.pageY - this.offsetTop;
    addLine();
    redraw(mouseX, mouseY);
  });

  //End line
  $("#displayArea").mouseleave(function(e) {
    drawMode = false;
    eraseMode = false;
    mouseX = e.pageX - this.offsetLeft;
    mouseY = e.pageY - this.offsetTop;
    addLine();
    redraw(mouseX, mouseY);
  });

  function trashit(){
    let check = window.confirm("Clear Layer?");
    if(check){
      reset();
      redraw(0,0);
    }
  }
  //Leap Motion Mode
  //Check if the LeapMotion is connected
  let controller = Leap.loop({enableGestures: true}, function(frame) {
    extendedFingers = 0;
    if (frame.hands.length != 1) {
      drawMode = false;
      eraseMode = false;
      //alternatively, allow for mouse functionality
    }
    else {
      let hand = frame.hands[0];
      for (let f = 0; f < hand.fingers.length; f++) {
        if (hand.fingers[f].extended) {
          extendedFingers++;
        }
      }
      if (extendedFingers == 5 && frame.valid && frame.gestures.length > 0) {
        frame.gestures.forEach(function(gesture) {
          if (gesture.type == "swipe") {
            //create new canvas with z-index++
            //set display area to new canvas
            //call reset() to reset all fields for drawing fresh
          }
        });
      }
      else if (extendedFingers == 1) {
        let indexFinger = hand.indexFinger;
        let pinkyFinger = hand.pinky;
        let interactionBox = frame.interactionBox;
        let normalizedPosition = undefined;
        if (indexFinger.extended) {
          if (!drawMode) {
            drawMode = true;
            displayArea.lineWidth = 5;
            clickX = new Array();
            clickY = new Array();
            clickColor = new Array();
            clickMode = "draw";
            document.getElementById("color").disabled = false;
            document.getElementById("draw").checked = true;
            document.getElementById("erase").checked = false;
          }
          normalizedPosition = interactionBox.normalizePoint(indexFinger.stabilizedTipPosition, true);
        }
        else if (pinkyFinger.extended) {
          if (!eraseMode) {
            eraseMode = true;
            displayArea.lineWidth = 10;
            clickX = new Array();
            clickY = new Array();
            clickColor = new Array();
            clickMode = "erase";
            prevColor = curColor;
            curColor = "#ffffff";
            document.getElementById("color").disabled = true;
            document.getElementById("draw").checked = false;
            document.getElementById("erase").checked = true;
          }
          normalizedPosition = interactionBox.normalizePoint(pinkyFinger.stabilizedTipPosition, true);
        }

        if ((drawMode || eraseMode) && normalizedPosition !== undefined){
          // Convert the normalized coordinates to span the canvas
          let canvasX = canvasElement.width * normalizedPosition[0];
          let canvasY = canvasElement.height * (1 - normalizedPosition[1]);
          //We can ignore z for a 2D context
          addPoint(canvasX, canvasY);
        }
      }
      else {
        //may also want to account for mouse functionality somehow if not using LeapMotion controls
        if (drawMode){ // If we're in draw mode, check if the index finger is no longer extended
          // Toggle out of drawMode
          drawMode = false;
          // Push to clickLines
          addLine();
        }
        else if (eraseMode){ // If we're in erase mode, check if the pinky finger is no longer extended
          // Toggle out of eraseMode
          eraseMode = false;
          // Push to clickLines
          addLine();
          curColor = prevColor;
        }
      }
    }
    redraw();
  });
  controller.connect();
  </script>

  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>

  <div id="main">
    <!-- <h1>Leap Motion Data</h1> -->
    <button id="pause" onclick="togglePause()">Pause</button>
    <input type="checkbox" id="pauseOnGesture" onclick="pauseForGestures()">Pause on gesture</input>
    <div style="clear:both;"></div>
    <h3>Finger and tool data:</h3>
    <div id="pointableData"></div>
    <div style="clear:both;"></div>
  </div>

</body>

</html>
